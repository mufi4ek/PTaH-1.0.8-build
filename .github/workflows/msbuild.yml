name: Build PTaH

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os_short }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-20.04
          - windows-latest
        include:
          - os: ubuntu-20.04
            os_short: linux
          - os: windows-latest
            os_short: windows

    steps:
    - name: Short SHA
      shell: bash
      run: echo "GITHUB_SHA_SHORT=${GITHUB_SHA::7}" >> $GITHUB_ENV

    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Upgrade pip and install AMBuild
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --no-build-isolation git+https://github.com/alliedmodders/ambuild

    - name: Install Linux build deps
      if: runner.os == 'Linux'
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y clang g++-multilib

    - name: Select clang compiler
      if: runner.os == 'Linux'
      run: |
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV

    - name: Setup MSVC (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        for /f "usebackq delims=*" %%i in (`vswhere -latest -property installationPath`) do (
          call "%%i"\Common7\Tools\vsdevcmd.bat -arch=x86 -host_arch=x64
        )
        for /f "delims== tokens=1,2" %%a in ('set') do (
          echo>>"%GITHUB_ENV%" %%a=%%b
        )

    - name: Checkout PTaH
      uses: actions/checkout@v3
      with:
        path: project

    - name: Download SourceMod 1.9.0.6167
      run: |
        curl -L -o sm.zip https://sm.alliedmods.net/smdrop/1.9/sourcemod-1.9.0-git6167-${{ matrix.os_short }}.zip
        mkdir sourcemod
        unzip sm.zip -d sourcemod || powershell -Command "Expand-Archive -Path 'sm.zip' -DestinationPath 'sourcemod'"

    - name: Download HL2SDK-CSGO
      run: |
        curl -L -o hl2sdk.zip https://github.com/alliedmodders/hl2sdk/archive/refs/heads/csgo.zip
        mkdir hl2sdk-csgo
        tar -xf hl2sdk.zip -C hl2sdk-csgo --strip-components=1 || powershell -Command "Expand-Archive -Path 'hl2sdk.zip' -DestinationPath 'hl2sdk-csgo'"

    - name: Configure AMBuild
      shell: bash
      run: |
        cd project
        ambuild configure --api 2.2 --build-dir build

    - name: Build PTaH
      shell: bash
      run: |
        cd project
        ambuild build --build-dir build

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PTaH-${{ matrix.os_short }}
        path: project/build/package
